# Роли и права доступа в системе Kafeshka

## Обзор ролей

В системе Kafeshka существует 4 основных роли:

1. **Пользователь (User)** - обычный клиент, делающий заказы
2. **Повар (Chef)** - повар ресторана, получающий заказы и управляющий ими
3. **Админ ресторана (Restaurant Admin)** - администратор конкретного ресторана (создается поваром)
4. **Супер-админ (Super Admin)** - системный администратор платформы

---

## 1. Пользователь (User)

### Описание
Обычный клиент, который делает заказы через Telegram-бота.

### Как становится пользователем
- Автоматически создается при первом обращении к боту
- Данные берутся из Telegram профиля

### Доступ к данным

#### ✅ Может:
- **Просматривать**:
  - Список всех активных ресторанов (через сайт или бот)
  - Детали ресторанов (название, описание, часы работы, меню)
  - Рекламные баннеры
  - Свои собственные заказы и их статусы

- **Создавать**:
  - Новые заказы через Telegram-бота
  - Свою учетную запись (автоматически)

- **Обновлять**:
  - Свои данные (имя, телефон) через бот

#### ❌ Не может:
- Видеть заказы других пользователей
- Изменять статусы заказов
- Управлять ресторанами
- Просматривать админ-панели
- Удалять заказы

### Таблицы БД
- `users` - может создавать и читать только свою запись
- `orders` - может создавать заказы и читать только свои
- `restaurants` - только чтение (активные)
- `banners` - только чтение (активные)

---

## 2. Повар (Chef)

### Описание
Повар ресторана, который получает заказы через Telegram-бота и обрабатывает их. Повары могут создавать админов для своего ресторана.

### Как становится поваром
- Создается супер-админом через админ-панель
- При создании указывается `telegram_chat_id` для получения уведомлений о заказах в боте
- Связывается с рестораном через таблицу `chefs`

### Доступ к данным

#### ✅ Может:
- **Просматривать**:
  - Все заказы своего ресторана (через Telegram-бота)
  - Статусы заказов своего ресторана
  - Историю изменений статусов заказов своего ресторана

- **Обновлять**:
  - Статусы заказов своего ресторана (только):
    - `pending` → `accepted` (принять)
    - `accepted` → `ready` (готово)
  - **НЕ может отменять заказы** (только админы могут отменять)

- **Создавать**:
  - Админов для своего ресторана (через админ-панель ресторана)

- **Управлять**:
  - Админами своего ресторана (создание, редактирование, удаление)

#### ❌ Не может:
- Видеть заказы других ресторанов
- Создавать заказы
- Удалять заказы
- Отменять заказы (только админы могут)
- Изменять данные ресторана напрямую (только через админа)
- Просматривать данные пользователей (кроме имени и username из Telegram)
- Управлять меню ресторана (только админы могут)
- Управлять настройками ресторана (только админы могут)

### Таблицы БД
- `chefs` - может читать только свою запись
- `orders` - может читать и обновлять только заказы своего ресторана (`restaurant_id`)
- `order_status_history` - может читать историю заказов своего ресторана
- `restaurant_admins` - может создавать, читать, обновлять и удалять админов для своего ресторана
- `restaurants` - может читать только свою запись

### Ограничения
- Доступ к заказам только через Telegram-бота
- Может изменять статусы только на "принят" и "готов"
- Не может отменять заказы
- Не имеет доступа к веб-интерфейсу управления рестораном (только админы)

---

## 3. Админ ресторана (Restaurant Admin)

### Описание
Администратор конкретного ресторана с расширенными правами. Создается поваром для управления рестораном.

### Как становится админом ресторана
- Создается поваром через админ-панель ресторана
- Связывается с рестораном через таблицу `restaurant_admins`
- Имеет свой `telegram_id` для доступа

### Доступ к данным

#### ✅ Может:
- **Все возможности повара** (кроме создания админов) +
- **Просматривать**:
  - Статистику заказов своего ресторана
  - Аналитику по заказам
  - Список всех заказов ресторана (включая историю)
  - Админ-панель ресторана (веб-интерфейс)

- **Управлять**:
  - Меню ресторана (через админ-панель)
  - Часами работы (через админ-панель)
  - Баннерами ресторана (через админ-панель)
  - Настройками ресторана

- **Обновлять**:
  - Информацию о ресторане (описание, телефон)
  - Статусы заказов (включая отмену)

- **Отменять**:
  - Заказы (может изменять статус на `cancelled`)

#### ❌ Не может:
- Управлять другими ресторанами
- Видеть заказы других ресторанов
- Удалять заказы
- Управлять пользователями
- Изменять системные настройки
- Создавать других админов (только повар может)

### Таблицы БД
- `restaurant_admins` - может читать свою запись
- `restaurants` - может читать и обновлять только свой ресторан
- `orders` - полный доступ к заказам своего ресторана (включая отмену)
- `banners` - может создавать/обновлять баннеры для своего ресторана
- `order_status_history` - полный доступ к истории заказов ресторана
- `menu_items` - может создавать, обновлять, удалять пункты меню своего ресторана

### Ограничения
- Доступ ограничен одним рестораном
- Не может создавать/удалять рестораны
- Не имеет доступа к системным настройкам
- Не может создавать других админов (только повар может)

---

## 4. Супер-админ (Super Admin)

### Описание
Системный администратор платформы с полным доступом.

### Как становится супер-админом
- Настраивается через Supabase (service role key)
- Имеет доступ к backend API с service role

### Доступ к данным

#### ✅ Может:
- **Просматривать**:
  - Все данные в системе
  - Все рестораны (включая неактивные)
  - Все заказы всех ресторанов
  - Всех пользователей
  - Всех поваров
  - Всех админов ресторанов
  - Всю статистику и аналитику

- **Создавать**:
  - Новые рестораны
  - Поваров (chefs) с указанием `telegram_chat_id`
  - Баннеры
  - Тестовые данные

- **Обновлять**:
  - Любые данные в системе
  - Статусы любых заказов
  - Настройки ресторанов
  - Системные настройки

- **Удалять**:
  - Рестораны
  - Заказы (в исключительных случаях)
  - Пользователей
  - Поваров
  - Админов ресторанов
  - Баннеры

- **Управлять**:
  - RLS политиками (через Supabase)
  - Системными настройками
  - Доступами всех ролей

#### ❌ Не может:
- Нарушать целостность данных (ограничения БД)
- Обходить RLS без service role key

### Таблицы БД
- **Полный доступ ко всем таблицам**:
  - `restaurants` - CRUD
  - `users` - CRUD
  - `orders` - CRUD
  - `chefs` - CRUD
  - `restaurant_admins` - CRUD
  - `banners` - CRUD
  - `order_status_history` - CRUD
  - `bot_settings` - CRUD
  - `restaurant_categories` - CRUD

### Доступ
- Backend API с service role key
- Supabase Dashboard
- Прямой доступ к БД (через Supabase)
- Супер-админ панель (веб-интерфейс)

---

## Матрица доступа к данным

| Действие | Пользователь | Повар | Админ ресторана | Супер-админ |
|----------|--------------|-------|-----------------|-------------|
| **Рестораны** |
| Просмотр активных | ✅ | ✅ | ✅ | ✅ |
| Просмотр всех | ❌ | ❌ | ❌ | ✅ |
| Создание | ❌ | ❌ | ❌ | ✅ |
| Обновление своих | ❌ | ❌ | ✅ | ✅ |
| Удаление | ❌ | ❌ | ❌ | ✅ |
| **Заказы** |
| Просмотр своих | ✅ | ✅ (свои) | ✅ (свои) | ✅ (все) |
| Создание | ✅ | ❌ | ❌ | ✅ |
| Обновление статуса | ❌ | ✅ (только accept/ready) | ✅ (все статусы) | ✅ (все) |
| Отмена заказа | ❌ | ❌ | ✅ (свои) | ✅ (все) |
| Удаление | ❌ | ❌ | ❌ | ✅ |
| **Пользователи** |
| Просмотр своих данных | ✅ | ❌ | ❌ | ✅ |
| Просмотр всех | ❌ | ❌ | ❌ | ✅ |
| Создание | ✅ (авто) | ❌ | ❌ | ✅ |
| Обновление | ✅ (свои) | ❌ | ❌ | ✅ |
| **Баннеры** |
| Просмотр активных | ✅ | ✅ | ✅ | ✅ |
| Создание | ❌ | ❌ | ✅ (свои) | ✅ |
| Обновление | ❌ | ❌ | ✅ (свои) | ✅ |
| Удаление | ❌ | ❌ | ❌ | ✅ |
| **Повары (Chefs)** |
| Просмотр | ❌ | ✅ (свои) | ❌ | ✅ |
| Создание | ❌ | ❌ | ❌ | ✅ |
| Удаление | ❌ | ❌ | ❌ | ✅ |
| **Админы ресторанов** |
| Просмотр | ❌ | ✅ (свои) | ✅ (свои) | ✅ |
| Создание | ❌ | ✅ (свои) | ❌ | ✅ |
| Удаление | ❌ | ✅ (свои) | ❌ | ✅ |
| **Меню** |
| Просмотр | ✅ | ❌ | ✅ (свои) | ✅ |
| Создание/Обновление | ❌ | ❌ | ✅ (свои) | ✅ |
| Удаление | ❌ | ❌ | ✅ (свои) | ✅ |

---

## RLS (Row Level Security) политики

### Текущие политики в БД:

#### `restaurants`
```sql
-- Публичный доступ на чтение активных ресторанов
CREATE POLICY "Public can view active restaurants"
    ON restaurants FOR SELECT
    USING (is_active = true);
```

#### `users`
```sql
-- Пользователи могут создавать свои записи
CREATE POLICY "Users can insert own data"
    ON users FOR INSERT
    WITH CHECK (true);

-- Пользователи могут видеть свои данные
CREATE POLICY "Users can view own data"
    ON users FOR SELECT
    USING (true); -- В реальности проверять через JWT
```

#### `orders`
```sql
-- Публичный доступ на создание заказов
CREATE POLICY "Anyone can create orders"
    ON orders FOR INSERT
    WITH CHECK (true);

-- Пользователи могут видеть свои заказы
CREATE POLICY "Users can view own orders"
    ON orders FOR SELECT
    USING (true); -- В реальности проверять user_id через JWT

-- Рестораны могут обновлять свои заказы
CREATE POLICY "Restaurants can update own orders"
    ON orders FOR UPDATE
    USING (true); -- В реальности проверять restaurant_id через service role
```

#### `banners`
```sql
-- Публичный доступ на чтение активных баннеров
CREATE POLICY "Public can view active banners"
    ON banners FOR SELECT
    USING (is_active = true);
```

#### `chefs`
```sql
-- Повары могут видеть только свои записи
CREATE POLICY "Chefs can view own data"
    ON chefs FOR SELECT
    USING (true); -- В реальности проверять через service role или JWT
```

---

## Доступ через интерфейсы

### Telegram-бот
- **Пользователи**: Полный доступ к созданию заказов
- **Повары**: Получение заказов и управление статусами (только accept/ready)
- **Админы ресторанов**: Расширенный доступ через веб-интерфейс

### Веб-сайт (Frontend)
- **Пользователи**: Просмотр ресторанов и меню
- **Повары**: Нет доступа к веб-интерфейсу
- **Админы ресторанов**: Админ-панель ресторана (управление меню, настройками, заказами)
- **Супер-админ**: Супер-админ панель (управление всеми данными)

### Backend API
- **Пользователи**: Ограниченный доступ (создание заказов)
- **Повары**: Обновление статусов через бот (только accept/ready)
- **Админы ресторанов**: Полный доступ к данным своего ресторана
- **Супер-админ**: Полный доступ через service role key

---

## Безопасность

### Текущие меры:
1. **RLS политики** - ограничивают доступ на уровне БД
2. **Service Role Key** - только для backend, не передается на frontend
3. **Telegram авторизация** - пользователи идентифицируются через Telegram ID
4. **Валидация данных** - проверка на backend перед сохранением
5. **Ограничения поваров** - повары могут только принимать и отмечать как готовые, не могут отменять

### Рекомендации для production:
1. **JWT токены** - для веб-авторизации
2. **API ключи** - для ресторанов и админов
3. **Rate limiting** - ограничение запросов
4. **Аудит логи** - логирование всех действий админов
5. **2FA** - для супер-админов

---

## Примеры использования

### Пользователь делает заказ:
1. Пользователь открывает бот → `/start`
2. Выбирает ресторан
3. Описывает заказ
4. Отправляет адрес
5. Заказ создается в БД со статусом `pending`
6. Повар получает уведомление в Telegram

### Повар обрабатывает заказ:
1. Повар получает заказ в Telegram
2. Нажимает "Принять" → статус `accepted`
3. Готовит заказ
4. Нажимает "Готово" → статус `ready`
5. Пользователь получает уведомления на каждом этапе

### Повар создает админа:
1. Повар заходит в админ-панель ресторана (если есть доступ)
2. Переходит в раздел "Админы"
3. Создает нового админа, указывая Telegram ID
4. Админ получает полный доступ к управлению рестораном

### Супер-админ создает повара:
1. Создает повара через супер-админ панель
2. Указывает ресторан, Telegram ID и **Telegram Chat ID** (для получения уведомлений)
3. Повар начинает получать заказы в Telegram-боте

---

## Будущие улучшения

1. **Расширенные роли**:
   - Модератор (проверка ресторанов)
   - Курьер (доставка заказов)
   - Финансовый менеджер (оплаты)

2. **Улучшения безопасности**:
   - JWT токены для веб-авторизации
   - API ключи для ресторанов
   - Rate limiting

3. **Аналитика**:
   - Детальная статистика для поваров
   - Аналитика заказов для админов
   - Общая аналитика для супер-админа
